<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <title>Stopwatch</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
      background-color: #2b2b2b;
      color: white;
    }

    #stopwatch {
      font-size: 5rem;
      font-weight: bolder;
    }

    button {
      background-color: #373737;
      color: white;
      width: 125px;
      height: 50px;
      font-size: 1.4rem;
      border: none;
      border-radius: 50pc;
      cursor: pointer;
      transform: scale(0);
      opacity: 0;
      transition: background-color 0.3s, transform 0.4s, opacity 0.4s;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #resume {
      width: 150px;
    }

    #openPiP {
      width: 50px;
    }

    button i {
      text-align: center;
    }

    button svg {
      height: 80%;
      width: 80%;
    }

    button.visible {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    button.hidden {
      display: none;
    }

    button:hover {
      transform: scale(1.1);
      background-color: #4f4f4f;
    }

    button:active {
      transform: scale(0.9);
      background-color: #232323;
    }

    .watch-flex {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .watch-btn-flex {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="watch-flex">
    <div id="stopwatch">00:00</div>
    <div class="watch-btn-flex">
      <button class="visible" id="start" style="padding-left: 2px; padding-right: 0px;"><i class="fas fa-play"></i><p>Start</p></button>
      <button class="hidden" id="resume" style="padding-left: 2px; padding-right: 0px;"><i class="fas fa-play"></i><p>Resume</p></button>
      <button class="hidden" id="pause"><i class="fas fa-pause"></i><p>Pause</p></button>
      <button class="hidden" id="reset"><i class="fas fa-rotate-left"></i><p>Reset</p></button>
    </div>
    <button class="visible" id="openPiP"><svg width="40px" height="40px" viewBox="0 0 24 24" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd"
          d="M9.94358 2.25H14.0564C15.8942 2.24998 17.3498 2.24997 18.489 2.40314C19.6614 2.56076 20.6104 2.89288 21.3588 3.64124C22.1071 4.38961 22.4392 5.33856 22.5969 6.51098C22.75 7.65019 22.75 9.10583 22.75 10.9436V11C22.75 11.4142 22.4142 11.75 22 11.75C21.5858 11.75 21.25 11.4142 21.25 11C21.25 9.09318 21.2484 7.73851 21.1102 6.71085C20.975 5.70476 20.7213 5.12511 20.2981 4.7019C19.8749 4.27869 19.2952 4.02502 18.2892 3.88976C17.2615 3.75159 15.9068 3.75 14 3.75H10C8.09318 3.75 6.73851 3.75159 5.71085 3.88976C4.70476 4.02502 4.12511 4.27869 3.7019 4.7019C3.27869 5.12511 3.02502 5.70476 2.88976 6.71085C2.75159 7.73851 2.75 9.09318 2.75 11V13C2.75 14.9068 2.75159 16.2615 2.88976 17.2892C3.02502 18.2952 3.27869 18.8749 3.7019 19.2981C4.12511 19.7213 4.70476 19.975 5.71085 20.1102C6.73851 20.2484 8.09318 20.25 10 20.25H11C11.4142 20.25 11.75 20.5858 11.75 21C11.75 21.4142 11.4142 21.75 11 21.75H9.94359C8.10583 21.75 6.65019 21.75 5.51098 21.5969C4.33856 21.4392 3.38961 21.1071 2.64124 20.3588C1.89288 19.6104 1.56076 18.6614 1.40314 17.489C1.24997 16.3498 1.24998 14.8942 1.25 13.0564V10.9436C1.24998 9.10582 1.24997 7.65019 1.40314 6.51098C1.56076 5.33856 1.89288 4.38961 2.64124 3.64124C3.38961 2.89288 4.33856 2.56076 5.51098 2.40314C6.65019 2.24997 8.10582 2.24998 9.94358 2.25ZM6.96967 6.96967C7.26256 6.67678 7.73744 6.67678 8.03033 6.96967L10.75 9.68934V8.5C10.75 8.08579 11.0858 7.75 11.5 7.75C11.9142 7.75 12.25 8.08579 12.25 8.5V11.5C12.25 11.9142 11.9142 12.25 11.5 12.25H8.5C8.08579 12.25 7.75 11.9142 7.75 11.5C7.75 11.0858 8.08579 10.75 8.5 10.75H9.68934L6.96967 8.03033C6.67678 7.73744 6.67678 7.26256 6.96967 6.96967ZM16.948 12.25H18.052C18.9505 12.25 19.6997 12.2499 20.2945 12.3299C20.9223 12.4143 21.4891 12.6 21.9445 13.0555C22.4 13.5109 22.5857 14.0777 22.6701 14.7055C22.7501 15.3003 22.75 16.0495 22.75 16.948V17.052C22.75 17.9505 22.7501 18.6997 22.6701 19.2945C22.5857 19.9223 22.4 20.4891 21.9445 20.9445C21.4891 21.4 20.9223 21.5857 20.2945 21.6701C19.6997 21.7501 18.9505 21.75 18.052 21.75H16.948C16.0495 21.75 15.3003 21.7501 14.7055 21.6701C14.0777 21.5857 13.5109 21.4 13.0555 20.9445C12.6 20.4891 12.4143 19.9223 12.3299 19.2945C12.2499 18.6997 12.25 17.9505 12.25 17.052V16.948C12.25 16.0495 12.2499 15.3003 12.3299 14.7055C12.4143 14.0777 12.6 13.5109 13.0555 13.0555C13.5109 12.6 14.0777 12.4143 14.7055 12.3299C15.3003 12.2499 16.0495 12.25 16.948 12.25ZM14.9054 13.8165C14.4439 13.8786 14.2464 13.9858 14.1161 14.1161C13.9858 14.2464 13.8786 14.4439 13.8165 14.9054C13.7516 15.3884 13.75 16.036 13.75 17C13.75 17.964 13.7516 18.6116 13.8165 19.0946C13.8786 19.5561 13.9858 19.7536 14.1161 19.8839C14.2464 20.0142 14.4439 20.1214 14.9054 20.1835C15.3884 20.2484 16.036 20.25 17 20.25H18C18.964 20.25 19.6116 20.2484 20.0946 20.1835C20.5561 20.1214 20.7536 20.0142 20.8839 19.8839C21.0142 19.7536 21.1214 19.5561 21.1835 19.0946C21.2484 18.6116 21.25 17.964 21.25 17C21.25 16.036 21.2484 15.3884 21.1835 14.9054C21.1214 14.4439 21.0142 14.2464 20.8839 14.1161C20.7536 13.9858 20.5561 13.8786 20.0946 13.8165C19.6116 13.7516 18.964 13.75 18 13.75H17C16.036 13.75 15.3884 13.7516 14.9054 13.8165Z"
          fill="white" />
      </svg></button>
  </div>

  <script>
    let timerInterval;
    let elapsedTime = 0;
    let isRunning = false;
    let startTime = 0;
    let wasPaused = false;

    const stopwatchDisplay = document.getElementById('stopwatch');
    const startButton = document.getElementById('start');
    const resumeButton = document.getElementById('resume');
    const pauseButton = document.getElementById('pause');
    const resetButton = document.getElementById('reset');

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;

      if (hours > 0) {
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      } else {
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
    }

    function updateDisplay() {
      stopwatchDisplay.textContent = formatTime(elapsedTime);
    }

    function getState() {
      return {
        elapsedTime,
        isRunning,
        paused: !isRunning && elapsedTime > 0
      };
    }

    function setButtons() {
      const allButtons = [startButton, resumeButton, pauseButton, resetButton];
      let show = [];
      if (isRunning) {
        show = [pauseButton];
      } else if (elapsedTime > 0) {
        show = [resumeButton, resetButton];
      } else {
        show = [startButton];
      }

      const currentlyVisible = allButtons.filter(btn => btn.classList.contains("visible"));
      const toShow = show.filter(btn => !btn.classList.contains("visible"));
      const toHide = currentlyVisible.filter(btn => !show.includes(btn));

      if (toHide.length > 0) {
        let transitionsLeft = toHide.length;
        toHide.forEach(btn => {
          btn.classList.remove("visible");
          btn.addEventListener("transitionend", function handler() {
            btn.classList.add("hidden");
            btn.removeEventListener("transitionend", handler);
            transitionsLeft--;
            if (transitionsLeft === 0) {
              toShow.forEach(showBtn => {
                showBtn.classList.remove("hidden");
                void showBtn.offsetWidth;
                setTimeout(() => {
                  showBtn.classList.add("visible");
                }, 10);
              });
            }
          });
        });
      } else {
        toShow.forEach(showBtn => {
          showBtn.classList.remove("hidden");
          void showBtn.offsetWidth;
          setTimeout(() => {
            showBtn.classList.add("visible");
          }, 350);
        });
      }

      allButtons.forEach(btn => {
        if (show.includes(btn)) {
          btn.style.pointerEvents = "auto";
        } else {
          btn.style.pointerEvents = "none";
        }
      });
    }

    function startStopwatch() {
      if (!isRunning) {
        isRunning = true;
        startTime = Date.now() - elapsedTime;
        timerInterval = setInterval(tickAndBroadcast, 100);
        setButtons();
        broadcastState();
      }
    }

    function pauseStopwatch() {
      if (isRunning) {
        isRunning = false;
        clearInterval(timerInterval);
        setButtons();
        broadcastState();
      }
    }

    function resetStopwatch() {
      isRunning = false;
      clearInterval(timerInterval);
      elapsedTime = 0;
      updateDisplay();
      setButtons();
      broadcastState();
    }

    startButton.addEventListener('click', startStopwatch);
    resumeButton.addEventListener('click', startStopwatch);
    pauseButton.addEventListener('click', pauseStopwatch);
    resetButton.addEventListener('click', resetStopwatch);

    updateDisplay();
    setButtons();

    const channel = new BroadcastChannel('stopwatch-sync');

    function broadcastState() {
      channel.postMessage(getState());
    }

    function tickAndBroadcast() {
      elapsedTime = Date.now() - startTime;
      updateDisplay();
      broadcastState();
    }

    channel.onmessage = (event) => {
      if (event.data.command === "pause") pauseStopwatch();
      if (event.data.command === "reset") resetStopwatch();
      if (event.data.command === "start") startStopwatch();
      if (event.data.requestState) broadcastState();
    };

    document.getElementById("openPiP").addEventListener("click", async () => {
      if (!("documentPictureInPicture" in window)) {
        alert("Not supported");
        return;
      }

      const pipChannel = new BroadcastChannel('stopwatch-sync');
      let pipTimerEl;
      let pipButtons = {};

      async function setPiPButtons(state) {
        if (!pipButtons.startBtn) return;

        const { startBtn, pauseBtn, resumeBtn, resetBtn } = pipButtons;
        const allButtons = [startBtn, pauseBtn, resumeBtn, resetBtn];

        let show = [];
        if (state.isRunning) {
          show = [pauseBtn];
        } else if (state.paused) {
          show = [resumeBtn, resetBtn];
        } else {
          show = [startBtn];
        }

        allButtons.forEach(btn => {
          if (show.includes(btn)) {
            if (!btn.classList.contains("visible")) {
              btn.classList.remove("hidden");
              void btn.offsetWidth;
              btn.classList.add("visible");
            }
            btn.style.pointerEvents = "auto";
          } else {
            if (btn.classList.contains("visible")) {
              btn.classList.remove("visible");
              btn.addEventListener("transitionend", function handler() {
                btn.classList.add("hidden");
                btn.removeEventListener("transitionend", handler);
              });
            }
            btn.style.pointerEvents = "none";
          }
        });
      }

      pipChannel.onmessage = async (event) => {
        const { elapsedTime, isRunning, paused } = event.data;
        if (typeof elapsedTime === "number") {
          pipTimerEl.textContent = formatTime(elapsedTime);
          const state = { isRunning, paused };
          const nextVisible = getPiPButtonsForState(state, pipButtons);
          if (
            nextVisible.length !== currentVisiblePiPButtons.length ||
            nextVisible.some((btn, i) => btn !== currentVisiblePiPButtons[i])
          ) {
            switchButtonsQueued(currentVisiblePiPButtons, nextVisible);
          }
        }
      };

      const pipWindow = await documentPictureInPicture.requestWindow({
        width: 350,
        height: 225,
      });

      const waitForBody = new Promise((resolve) => {
        const check = () => {
          if (pipWindow.document.body) resolve();
          else setTimeout(check, 10);
        };
        check();
      });

      await waitForBody;

      const style = document.createElement("style");
      style.textContent = `
    html { width: 100%; height: 100%; }
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    button {
      background-color: #373737;
      color: white;
      padding-top: 4px;
      width: 50px;
      height: 50px;
      font-size: 1.4rem;
      border: none;
      border-radius: 50pc;
      cursor: pointer;
      transform: scale(0);
      opacity: 0;
      transition: background-color 0.3s, transform 0.4s, opacity 0.4s;
      pointer-events: none;
    }
    button.visible {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    button.hidden { display: none; }

    button:hover { transform: scale(1.1); background-color: #4f4f4f; }
    button:active { transform: scale(0.9); background-color: #232323; }
    
    #timer { font-size: 5rem; }
    #buttonContainer { display: flex; gap: 10px; }
    #appContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      width: calc(100% - 40px);
      height: calc(100% - 40px);
      font-weight: bolder;
      user-select: none;
      overflow: hidden;
      opacity: 0;
      transition: opacity 1s ease;
    }
    #appContainer.visible { opacity: 1; }
    `;
      pipWindow.document.head.appendChild(style);

      pipTimerEl = document.createElement("div");
      pipTimerEl.textContent = "00:00";
      pipTimerEl.id = "timer";

      pipButtons.pauseBtn = document.createElement("button");
      pipButtons.pauseBtn.innerHTML = `<i class="fas fa-pause"></i>`;
      pipButtons.pauseBtn.classList.add("hidden");

      pipButtons.resumeBtn = document.createElement("button");
      pipButtons.resumeBtn.innerHTML = `<i class="fas fa-play"></i>`;
      pipButtons.resumeBtn.style.paddingLeft = "2px";
      pipButtons.resumeBtn.style.paddingRight = "0px";
      pipButtons.resumeBtn.classList.add("hidden");

      pipButtons.resetBtn = document.createElement("button");
      pipButtons.resetBtn.innerHTML = `<i class="fas fa-rotate-left"></i>`;
      pipButtons.resetBtn.classList.add("hidden");

      pipButtons.startBtn = document.createElement("button");
      pipButtons.startBtn.innerHTML = `<i class="fas fa-play"></i>`;
      pipButtons.startBtn.style.paddingLeft = "2px";
      pipButtons.startBtn.style.paddingRight = "0px";
      pipButtons.startBtn.classList.add("hidden");

      const buttonContainer = document.createElement("div");
      buttonContainer.id = "buttonContainer";
      buttonContainer.appendChild(pipButtons.startBtn);
      buttonContainer.appendChild(pipButtons.pauseBtn);
      buttonContainer.appendChild(pipButtons.resumeBtn);
      buttonContainer.appendChild(pipButtons.resetBtn);

      const appContainer = pipWindow.document.createElement("div");
      appContainer.id = "appContainer";
      appContainer.appendChild(pipTimerEl);
      appContainer.appendChild(buttonContainer);

      pipWindow.document.body.append(appContainer);
      const faLink = document.createElement("link");
      faLink.rel = "stylesheet";
      faLink.href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css";
      pipWindow.document.head.appendChild(faLink);

      setTimeout(() => {
        appContainer.classList.add("visible");
      }, 500);

      let currentVisiblePiPButtons = [];
      let transitionPromise = Promise.resolve();
      let latestNextVisible = null;

      function getPiPButtonsForState(state, pipButtons) {
        if (state.isRunning) return [pipButtons.pauseBtn];
        if (state.paused) return [pipButtons.resumeBtn, pipButtons.resetBtn];
        return [pipButtons.startBtn];
      }

      function transitionOut(button) {
        return new Promise(resolve => {
          if (!button.classList.contains("visible")) {
            button.classList.add("hidden");
            return resolve();
          }
          const onTransitionEnd = () => {
            button.removeEventListener("transitionend", onTransitionEnd);
            button.classList.add("hidden");
            resolve();
          };
          button.addEventListener("transitionend", onTransitionEnd);
          button.classList.remove("visible");
        });
      }

      async function switchButtonsQueued(outgoingButtons = [], incomingButtons = []) {
        latestNextVisible = incomingButtons;
        await transitionPromise;
        if (latestNextVisible !== incomingButtons) return;
        transitionPromise = (async () => {
          await Promise.all(outgoingButtons.map(btn => transitionOut(btn)));
          if (latestNextVisible !== incomingButtons) return;
          for (const btn of incomingButtons) {
            btn.classList.remove("hidden");
            void btn.offsetWidth;
            setTimeout(() => {
              btn.classList.add("visible");
            }, 10);
          }
          currentVisiblePiPButtons = incomingButtons;
        })();
        await transitionPromise;
      }

      pipButtons.startBtn.addEventListener("click", () => {
        pipChannel.postMessage({ command: "start" });
      });
      pipButtons.pauseBtn.addEventListener("click", () => {
        pipChannel.postMessage({ command: "pause" });
      });
      pipButtons.resumeBtn.addEventListener("click", () => {
        pipChannel.postMessage({ command: "start" });
      });
      pipButtons.resetBtn.addEventListener("click", () => {
        pipChannel.postMessage({ command: "reset" });
      });

      pipChannel.postMessage({ requestState: true });
    });
  </script>
</body>

</html>